<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FFUAV Live Operations Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
:root {
  --bg:#020617;
  --card:#0f172a;
  --border:#1e293b;
  --ok:#22c55e;
  --warn:#f59e0b;
  --danger:#dc2626;
  --text:#e5e7eb;
  --muted:#9ca3af;
}

body {
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
}

header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 22px;
  border-bottom:1px solid var(--border);
}

header h1 {
  font-size:18px;
  margin:0;
}

.badge {
  padding:6px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
}

.container {
  display:grid;
  grid-template-columns: 420px 1fr;
  height: calc(100vh - 60px);
}

.sidebar {
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

.card {
  background:var(--card);
  border-radius:12px;
  padding:14px;
  border:1px solid var(--border);
}

.card h3 {
  margin:0 0 10px;
  font-size:13px;
  color:var(--muted);
}

.metric {
  display:flex;
  justify-content:space-between;
  margin:6px 0;
  font-size:14px;
}

.alert {
  padding:10px;
  border-radius:8px;
  font-size:13px;
  font-weight:600;
}

.alert.ok { background:rgba(34,197,94,0.15); color:var(--ok); }
.alert.warn { background:rgba(245,158,11,0.15); color:var(--warn); }
.alert.danger { background:rgba(220,38,38,0.15); color:var(--danger); }

#map {
  width:100%;
  height:100%;
}
</style>
</head>

<body>

<header>
  <h1><i class="fas fa-helicopter"></i> FFUAV Operations Dashboard</h1>
  <span id="statusBadge" class="badge">UNKNOWN</span>
</header>

<div class="container">

  <div class="sidebar">

    <div class="card">
      <h3>Telemetry</h3>
      <div class="metric"><span>Battery</span><strong id="battery">--%</strong></div>
      <div class="metric"><span>Altitude</span><strong id="altitude">-- m</strong></div>
      <div class="metric"><span>Speed</span><strong id="speed">-- m/s</strong></div>
      <div class="metric"><span>Temperature</span><strong id="temp">-- °C</strong></div>
      <div class="metric"><span>Last Update</span><strong id="lastUpdate">--</strong></div>
    </div>

    <div class="card">
      <h3>Health Alerts</h3>
      <div id="alerts"></div>
    </div>

    <div class="card">
      <h3>Fire Detection</h3>
      <div class="metric"><span>Detected</span><strong id="fireDetected">NO</strong></div>
      <div class="metric"><span>Severity</span><strong id="fireSeverity">-</strong></div>
    </div>

  </div>

  <div id="map"></div>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, onSnapshot } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  
  mapboxgl.accessToken = "pk.eyJ1IjoiZmZ1YXYiLCJhIjoiY21sMGp4YmZxMGIyajNncXU4eHZ5b2wybSJ9.AEhvCSVnCw61znFwUnE4gg";
  
  const firebaseConfig = {
    apiKey: "AIzaSyD3j2PpWAjlOQo-8x22EIECrAvbYfwtvng",
    authDomain: "autonomous-ff-uav.firebaseapp.com",
    projectId: "autonomous-ff-uav"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  
  // ---------------- MAP ----------------
  const map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/dark-v11",
    center: [74.8560, 12.9141],
    zoom: 13
  });
  
  let pathCoords = [];
  
  map.on("load", () => {
    map.addSource("dronePath", {
      type: "geojson",
      data: {
        type: "Feature",
        geometry: { type: "LineString", coordinates: [] }
      }
    });
  
    map.addLayer({
      id: "dronePathLayer",
      type: "line",
      source: "dronePath",
      paint: {
        "line-color": "#22c55e",
        "line-width": 4
      }
    });
  });
  
  // Drone marker
  const marker = new mapboxgl.Marker({ color: "#22c55e" })
    .setLngLat([74.8560, 12.9141])
    .addTo(map);
  
  // ---------------- FIRESTORE ----------------
  const ref = doc(db, "drone_status", "drone_01");
  
  onSnapshot(ref, snap => {
    if (!snap.exists()) return;
    const d = snap.data();
  
    // VALIDATION (CRITICAL)
    if (typeof d.lat !== "number" || typeof d.lng !== "number") return;
  
    // UI
    battery.textContent = `${d.battery ?? "--"}%`;
    altitude.textContent = `${d.altitude ?? "--"} m`;
    speed.textContent = `${d.speed ?? "--"} m/s`;
    temp.textContent = `${d.temperature ?? "--"} °C`;
  
    // Status
    statusBadge.textContent = d.status ?? "UNKNOWN";
  
    // Move marker
    marker.setLngLat([d.lng, d.lat]);
    map.easeTo({ center: [d.lng, d.lat], duration: 500 });
  
    // Path
    pathCoords.push([d.lng, d.lat]);
    if (pathCoords.length > 200) pathCoords.shift();
  
    map.getSource("dronePath").setData({
      type: "Feature",
      geometry: {
        type: "LineString",
        coordinates: pathCoords
      }
    });
  
    // Alerts
    alerts.innerHTML = "";
    if (d.battery < 20)
      alerts.innerHTML += `<div class="alert danger">Battery Critical</div>`;
  });
  </script>
   

</body>
</html>
