<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FFUAV - Emergency Drone Dispatch</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html, body { height:100%; margin:0; }
#map { height:100vh; }
#system-status {
    position:absolute;
    top:0; left:0; right:0;
    padding:10px;
    text-align:center;
    font-weight:bold;
    color:white;
    z-index:1000;
}
.status-ready { background:#0891b2; }
.status-busy { background:#dc2626; }
.card-disabled { pointer-events:none; opacity:0.6; }
.mission-card {
    position:absolute;
    top:60px; left:20px;
    background:white;
    padding:15px;
    width:300px;
    border-radius:8px;
    z-index:1000;
}
</style>
</head>

<body>

<div id="system-status" class="status-ready">
STATUS: Connecting...
</div>

<div class="mission-card" id="main-card">
    <input id="reporter-name" placeholder="Name"><br><br>
    <input id="phone" placeholder="Phone"><br><br>
    <select id="severity-level">
        <option value="">Severity</option>
        <option value="low">Low</option>
        <option value="medium">Medium</option>
        <option value="high">High</option>
    </select><br><br>
    <input id="label" placeholder="Landmark"><br><br>
    <button id="deployBtn" onclick="sendMission()" disabled>SEND ALERT</button>
    <div id="status-msg"></div>
</div>

<div id="map"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
    getFirestore,
    collection,
    addDoc,
    serverTimestamp,
    doc,
    onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= FIREBASE ================= */

const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "autonomous-ff-uav.firebaseapp.com",
    projectId: "autonomous-ff-uav",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= MAP ================= */

const map = L.map('map').setView([12.9141, 74.8560], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'Â© OpenStreetMap contributors'
}).addTo(map);

let marker;
let selectedLat = null;
let selectedLng = null;
let isSystemBusy = false;
let missionListenerUnsub = null;

/* ================= SYSTEM STATUS LISTENER ================= */

const statusRef = doc(db, "drone_status", "drone_01");

onSnapshot(statusRef, (snap) => {

    const statusDiv = document.getElementById("system-status");
    const card = document.getElementById("main-card");

    if (!snap.exists()) {
        setFree();
        return;
    }

    isSystemBusy = snap.data().system_busy === true;

    if (isSystemBusy) {
        statusDiv.className = "status-busy";
        statusDiv.innerText = "STATUS: BUSY (Mission Active)";
        card.classList.add("card-disabled");
        disableMap();
    } else {
        setFree();
    }

    function setFree(){
        statusDiv.className = "status-ready";
        statusDiv.innerText = "STATUS: ONLINE (Ready)";
        card.classList.remove("card-disabled");
        enableMap();
    }

    function disableMap(){
        map.dragging.disable();
        map.touchZoom.disable();
        map.doubleClickZoom.disable();
        map.scrollWheelZoom.disable();
    }

    function enableMap(){
        map.dragging.enable();
        map.touchZoom.enable();
        map.doubleClickZoom.enable();
        map.scrollWheelZoom.enable();
    }
});

/* ================= MAP CLICK ================= */

map.on('click', function(e){

    if(isSystemBusy) return;

    selectedLat = e.latlng.lat;
    selectedLng = e.latlng.lng;

    if(marker) map.removeLayer(marker);

    marker = L.marker([selectedLat, selectedLng]).addTo(map);

    document.getElementById("deployBtn").disabled = false;
});

/* ================= VALIDATION ================= */

function validateForm(){

    const name = document.getElementById("reporter-name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const sev = document.getElementById("severity-level").value;

    if(!name) return "Name required";
    if(!sev) return "Severity required";
    if(!phone || phone.length !== 10 || isNaN(phone)) return "Valid 10-digit phone required";
    if(!selectedLat) return "Select location";

    return null;
}

/* ================= SEND MISSION ================= */

window.sendMission = async function(){

    if(isSystemBusy) return;

    const error = validateForm();
    if(error){
        document.getElementById("status-msg").innerText = error;
        return;
    }

    const btn = document.getElementById("deployBtn");
    btn.disabled = true;
    btn.innerText = "Sending...";

    const missionData = {
        reporterName: document.getElementById("reporter-name").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        severityLevel: document.getElementById("severity-level").value,
        label: document.getElementById("label").value.trim() || "Emergency Report",
        lat: selectedLat,
        lng: selectedLng,
        status: "PENDING",
        timestamp: serverTimestamp()
    };

    try{

        const docRef = await addDoc(collection(db, "missions"), missionData);

        document.getElementById("status-msg").innerText =
            "Alert sent. Waiting for dispatch...";

        /* LISTEN TO THIS MISSION */

        if(missionListenerUnsub) missionListenerUnsub();

        missionListenerUnsub = onSnapshot(docRef, (snap)=>{

            if(!snap.exists()) return;

            const mission = snap.data();

            if(mission.status === "ACTIVE"){
                document.getElementById("status-msg").innerText =
                    "Drone dispatched.";
            }

            if(mission.status === "COMPLETED"){
                document.getElementById("status-msg").innerText =
                    "Mission completed.";
                btn.disabled = false;
                btn.innerText = "SEND ALERT";
                missionListenerUnsub();
            }

        });

    }catch(e){
        console.error(e);
        document.getElementById("status-msg").innerText = "Failed to send.";
        btn.disabled = false;
        btn.innerText = "SEND ALERT";
    }

};

</script>
</body>
</html>
